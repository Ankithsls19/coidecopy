public with sharing class CTNAssignmentController {

    @AuraEnabled
    public static Id assignCTNs(List<Id> addressIds) {

        CTN_Assignment_Job__c job = new CTN_Assignment_Job__c(
            Status__c = 'IN_PROGRESS'
        );
        insert job;

        List<Address__c> addresses = [
            SELECT Id, Zip_Code__c, Area_Code__c
            FROM Address__c
            WHERE Id IN :addressIds
        ];

        // üîë Map<SearchKey, List<Address>>
        Map<String, List<Address__c>> searchKeyMap = new Map<String, List<Address__c>>();

        for (Address__c addr : addresses) {

            String searchKey;

            if (String.isNotBlank(addr.Zip_Code__c)) {
                searchKey = 'ZIP:' + addr.Zip_Code__c;
            } else if (String.isNotBlank(addr.Area_Code__c)) {
                searchKey = 'AREA:' + addr.Area_Code__c;
            } else {
                // Optional: handle invalid address
                continue;
            }

            searchKeyMap
                .computeIfAbsent(searchKey, new List<Address__c>())
                .add(addr);
        }

        Integer totalBatches = 0;

        // üîÅ Create batches of 5
        for (String searchKey : searchKeyMap.keySet()) {

            List<Address__c> group = searchKeyMap.get(searchKey);

            for (Integer i = 0; i < group.size(); i += 5) {

                totalBatches++;

                List<Address__c> batch =
                    group.subList(i, Math.min(i + 5, group.size()));

                System.enqueueJob(
                    new CTNAssignmentQueueable(
                        searchKey,
                        batch,
                        job.Id
                    )
                );
            }
        }

        job.Total_Batches__c = totalBatches;
        update job;

        return job.Id;
    }
}












public class CTNAssignmentQueueable
        implements Queueable, Database.AllowsCallouts {

    private String searchKey;
    private List<Address__c> addresses;
    private Id jobId;

    public CTNAssignmentQueueable(
        String searchKey,
        List<Address__c> addresses,
        Id jobId
    ) {
        this.searchKey = searchKey;
        this.addresses = addresses;
        this.jobId = jobId;
    }

    public void execute(QueueableContext context) {
        try {
            String type = searchKey.split(':')[0];
            String value = searchKey.split(':')[1];

            List<String> ctns;

            if (type == 'ZIP') {
                ctns = CTNService.getCTNsByZip(value, addresses.size());
            } else {
                ctns = CTNService.getCTNsByAreaCode(value, addresses.size());
            }

            for (Integer i = 0; i < addresses.size(); i++) {
                addresses[i].CTN__c = ctns[i];
            }

            update addresses;

            incrementCompletedBatch();

        } catch (Exception e) {
            update new CTN_Assignment_Job__c(
                Id = jobId,
                Status__c = 'FAILED',
                Error_Message__c = e.getMessage()
            );
        }
    }

    private void incrementCompletedBatch() {
        CTN_Assignment_Job__c job = [
            SELECT Completed_Batches__c, Total_Batches__c
            FROM CTN_Assignment_Job__c
            WHERE Id = :jobId
            FOR UPDATE
        ];

        job.Completed_Batches__c++;

        if (job.Completed_Batches__c == job.Total_Batches__c) {
            job.Status__c = 'COMPLETED';
        }

        update job;
    }
}









public class CTNService {

    public static List<String> getCTNsByZip(String zip, Integer count) {
        return callApi('zipCode', zip, count);
    }

    public static List<String> getCTNsByAreaCode(String areaCode, Integer count) {
        return callApi('areaCode', areaCode, count);
    }

    private static List<String> callApi(
        String paramName,
        String paramValue,
        Integer count
    ) {
        HttpRequest req = new HttpRequest();
        req.setEndpoint(
            'callout:CTN_API?' +
            paramName + '=' + paramValue +
            '&count=' + count
        );
        req.setMethod('GET');

        HttpResponse res = new Http().send(req);

        if (res.getStatusCode() != 200) {
            throw new CalloutException('CTN API failed');
        }

        Map<String, Object> response =
            (Map<String, Object>) JSON.deserializeUntyped(res.getBody());

        return (List<String>) response.get('ctns');
    }
}

