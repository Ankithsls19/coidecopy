public with sharing class CTNAssignmentController {

    @AuraEnabled
    public static void assignCTNs(List<Object> requestList) {

        for (Object obj : requestList) {

            Map<String, Object> req =
                (Map<String, Object>) obj;

            String searchType  = (String) req.get('searchType');
            String searchValue = (String) req.get('searchValue');
            Integer count      = (Integer) req.get('count');

            Integer remaining = count;

            // ðŸ” Batch by max 5 per API call
            while (remaining > 0) {
                Integer batchSize = Math.min(5, remaining);
                remaining -= batchSize;

                System.enqueueJob(
                    new CTNAssignmentQueueable(
                        searchType,
                        searchValue,
                        batchSize
                    )
                );
            }
        }
    }
}







public class CTNAssignmentQueueable
        implements Queueable, Database.AllowsCallouts {

    private String searchType;
    private String searchValue;
    private Integer batchSize;

    public CTNAssignmentQueueable(
        String searchType,
        String searchValue,
        Integer batchSize
    ) {
        this.searchType = searchType;
        this.searchValue = searchValue;
        this.batchSize = batchSize;
    }

    public void execute(QueueableContext context) {

        List<String> ctns;

        if (searchType == 'ZIP') {
            ctns = CTNService.getCTNsByZip(searchValue, batchSize);
        } else {
            ctns = CTNService.getCTNsByAreaCode(searchValue, batchSize);
        }

        // ðŸ”¹ Optional: Do something with CTNs
        // insert CTN__c records
        // publish platform event
        // cache in custom metadata
    }
}



public class CTNService {

    public static List<String> getCTNsByZip(String zip, Integer count) {

        Map<String, Object> requestBody = new Map<String, Object>{
            'searchType'  => 'ZIP',
            'searchValue' => zip,
            'count'       => count
        };

        return callApi(requestBody);
    }

    public static List<String> getCTNsByAreaCode(String areaCode, Integer count) {

        Map<String, Object> requestBody = new Map<String, Object>{
            'searchType'  => 'AREA',
            'searchValue' => areaCode,
            'count'       => count
        };

        return callApi(requestBody);
    }


private static List<String> callApi(Map<String, Object> requestBody) {

        HttpRequest req = new HttpRequest();
        req.setEndpoint('callout:CTN_API'); // Named Credential
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json');
        req.setBody(JSON.serialize(requestBody));

        Http http = new Http();
        HttpResponse res = http.send(req);

        if (res.getStatusCode() != 200 && res.getStatusCode() != 201) {
            throw new CalloutException(
                'CTN API failed. Status: ' + res.getStatusCode()
            );
        }

        Map<String, Object> response =
            (Map<String, Object>) JSON.deserializeUntyped(res.getBody());

        return (List<String>) response.get('ctns');
    }
}

